using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Web;
using AmbucareDAL.Models;

namespace AmbucareDAL.Repository.DAL.Transaction
{
    public class T74046DAL:CommonDAL
    {

        public DataTable GetMedicineList( int T_request_Id)
        {
            //return Query("Select T74040.T_PRSCRPTN_DTL_ID, T74073.T_COST_TYPE_DTL_ID,NVL(T74040.T_ITEM_CODE, 'N/A') T_ITEM_CODE,T74044.T_STORE_ID,T74040.T_GEN_CODE, T74040.T_REQUEST_STRENGTH, T74040.T_FORM_ID, T74040.T_DRUG_ROUTE_CODE,RUFAIDA.V30001.PRODUCT_DESC,T74089.T_SALE_PRICE, GetDoseQuantity(T74040.T_PRSCRPTN_DTL_ID) DOSE_QUANTITY From T74039 Inner Join T74040 on T74039.T_PRESCRIPTION_ID = T74040.T_PRESCRIPTION_ID INNER JOIN T74041 ON T74041.T_REQUEST_ID = T74039.T_REQUEST_ID INNER JOIN T74044 ON T74044.T_AMBU_REG_ID = T74041.T_AMBU_REG_ID left outer join RUFAIDA.V30001  on V30001.ITEM_CODE = T74040.T_ITEM_CODE left outer join T74073 on T74073.T_ID = T74040.T_ITEM_CODE LEFT OUTER JOIN T74089 ON T74089.T_COST_TYPE_DTL_ID = T74073.T_COST_TYPE_DTL_ID Where T74039.T_request_Id = " + T_request_Id + "");

            //-------------------------------------Working--------------------------------------

            //return Query("SELECT * FROM ( SELECT T74040.T_PRSCRPTN_DTL_ID,  T74073.T_COST_TYPE_DTL_ID,  NVL(T74040.T_ITEM_CODE, 'N/A') T_ITEM_CODE,  T74044.T_STORE_ID,  T74027.T_ITEM_UM_ID,  T74003.T_LANG2_NAME PACK_SIZE,   fn_Stock_Qty(T74040.T_ITEM_CODE,T74027.T_ITEM_UM_ID,T74044.T_STORE_ID) STOCK,   T74003.T_QTY BOX_QTY,   (fn_Stock_Qty(T74040.T_ITEM_CODE,T74027.T_ITEM_UM_ID,T74044.T_STORE_ID)*T74003.T_QTY) PCS_QTY, fn_Pcs_Price(T74073.T_COST_TYPE_DTL_ID) PCS_PRICE,  T74040.T_GEN_CODE,  T74040.T_REQUEST_STRENGTH,  T74040.T_FORM_ID,  T74040.T_DRUG_ROUTE_CODE,  RUFAIDA.V30001.PRODUCT_DESC,  T74089.T_SALE_PRICE, GetDoseQuantity(T74040.T_PRSCRPTN_DTL_ID) DOSE_QUANTITY FROM T74039 INNER JOIN T74040 ON T74039.T_PRESCRIPTION_ID = T74040.T_PRESCRIPTION_ID INNER JOIN T74041 ON T74041.T_REQUEST_ID = T74039.T_REQUEST_ID INNER JOIN T74044 ON T74044.T_AMBU_REG_ID = T74041.T_AMBU_REG_ID LEFT OUTER JOIN T74027 ON T74027.T_ITEM_ID = T74040.T_ITEM_CODE LEFT OUTER JOIN T74003 ON T74003.T_ITEM_UM_ID = T74027.T_ITEM_UM_ID LEFT OUTER JOIN RUFAIDA.V30001 ON V30001.ITEM_CODE = T74040.T_ITEM_CODE LEFT OUTER JOIN T74073 ON T74073.T_ID = T74040.T_ITEM_CODE LEFT OUTER JOIN T74089 ON T74089.T_COST_TYPE_DTL_ID = T74073.T_COST_TYPE_DTL_ID WHERE T74039.T_request_Id    = " + T_request_Id + " AND T74027.T_ITEM_UM_ID = T74089.T_ITEM_UM_ID AND T74089.T_ACTIVE = '1' GROUP BY T74040.T_PRSCRPTN_DTL_ID,  T74073.T_COST_TYPE_DTL_ID,   T74040.T_ITEM_CODE,  T74044.T_STORE_ID,  T74027.T_ITEM_UM_ID,  T74003.T_LANG2_NAME,  T74003.T_QTY,  T74040.T_GEN_CODE,  T74040.T_REQUEST_STRENGTH,  T74040.T_FORM_ID,  T74040.T_DRUG_ROUTE_CODE,  RUFAIDA.V30001.PRODUCT_DESC,  T74089.T_SALE_PRICE  UNION  SELECT T74040.T_PRSCRPTN_DTL_ID,  T74073.T_COST_TYPE_DTL_ID,  NVL(T74040.T_ITEM_CODE, 'N/A') T_ITEM_CODE,  T74044.T_STORE_ID,  T74027.T_ITEM_UM_ID,  T74003.T_LANG2_NAME PACK_SIZE,  fn_Stock_Qty(T74040.T_ITEM_CODE,T74027.T_ITEM_UM_ID,T74044.T_STORE_ID) STOCK,  T74003.T_QTY BOX_QTY,  (fn_Stock_Qty(T74040.T_ITEM_CODE,T74027.T_ITEM_UM_ID,T74044.T_STORE_ID)*T74003.T_QTY) PCS_QTY, fn_Pcs_Price(T74073.T_COST_TYPE_DTL_ID) PCS_PRICE,T74040.T_GEN_CODE,  T74040.T_REQUEST_STRENGTH,  T74040.T_FORM_ID,  T74040.T_DRUG_ROUTE_CODE,  RUFAIDA.V30001.PRODUCT_DESC,  T74089.T_SALE_PRICE,  GetDoseQuantity(T74040.T_PRSCRPTN_DTL_ID) DOSE_QUANTITY FROM T74039 INNER JOIN T74040 ON T74039.T_PRESCRIPTION_ID = T74040.T_PRESCRIPTION_ID INNER JOIN T74041 ON T74041.T_REQUEST_ID = T74039.T_REQUEST_ID INNER JOIN T74044 ON T74044.T_AMBU_REG_ID = T74041.T_AMBU_REG_ID LEFT OUTER JOIN T74027 ON T74027.T_ITEM_ID = T74040.T_ITEM_CODE LEFT OUTER JOIN T74003 ON T74003.T_ITEM_UM_ID = T74027.T_ITEM_UM_ID LEFT OUTER JOIN RUFAIDA.V30001  ON V30001.ITEM_CODE = T74040.T_ITEM_CODE LEFT OUTER JOIN T74073 ON T74073.T_ID = T74040.T_ITEM_CODE LEFT OUTER JOIN T74089 ON T74089.T_COST_TYPE_DTL_ID = T74073.T_COST_TYPE_DTL_ID WHERE T74039.T_request_Id    = " + T_request_Id + " AND T74040.T_ITEM_CODE IS NULL GROUP BY T74040.T_PRSCRPTN_DTL_ID,T74073.T_COST_TYPE_DTL_ID, T74040.T_ITEM_CODE,T74044.T_STORE_ID,T74027.T_ITEM_UM_ID,T74003.T_LANG2_NAME, T74003.T_QTY, T74040.T_GEN_CODE, T74040.T_REQUEST_STRENGTH, T74040.T_FORM_ID,T74040.T_DRUG_ROUTE_CODE,RUFAIDA.V30001.PRODUCT_DESC, T74089.T_SALE_PRICE ORDER BY BOX_QTY ) ORDER BY T_ITEM_CODE,BOX_QTY");

            return Query("SELECT * FROM ( SELECT T74040.T_PRSCRPTN_DTL_ID,  T74073.T_COST_TYPE_DTL_ID,  NVL(T74040.T_ITEM_CODE, 'N/A') T_ITEM_CODE,  T74044.T_STORE_ID,  T74027.T_ITEM_UM_ID,  T74003.T_LANG2_NAME PACK_SIZE,   fn_Stock_Qty(T74040.T_ITEM_CODE,T74027.T_ITEM_UM_ID,T74044.T_STORE_ID) STOCK,   T74003.T_QTY BOX_QTY,   (fn_Stock_Qty(T74040.T_ITEM_CODE,T74027.T_ITEM_UM_ID,T74044.T_STORE_ID)*T74003.T_QTY) PCS_QTY, fn_Pcs_Price(T74073.T_COST_TYPE_DTL_ID) PCS_PRICE,  T74040.T_GEN_CODE,  T74040.T_REQUEST_STRENGTH,  T74040.T_FORM_ID,  T74040.T_DRUG_ROUTE_CODE,  RUFAIDA.V30001.PRODUCT_DESC,  T74089.T_SALE_PRICE, T74040.T_DOSE_DURATION_CODE DOSE_QUANTITY FROM T74039 INNER JOIN T74040 ON T74039.T_PRESCRIPTION_ID = T74040.T_PRESCRIPTION_ID INNER JOIN T74041 ON T74041.T_REQUEST_ID = T74039.T_REQUEST_ID INNER JOIN T74044 ON T74044.T_AMBU_REG_ID = T74041.T_AMBU_REG_ID LEFT OUTER JOIN T74027 ON T74027.T_ITEM_ID = T74040.T_ITEM_CODE LEFT OUTER JOIN T74003 ON T74003.T_ITEM_UM_ID = T74027.T_ITEM_UM_ID LEFT OUTER JOIN RUFAIDA.V30001 ON V30001.ITEM_CODE = T74040.T_ITEM_CODE LEFT OUTER JOIN T74073 ON T74073.T_ID = T74040.T_ITEM_CODE LEFT OUTER JOIN T74089 ON T74089.T_COST_TYPE_DTL_ID = T74073.T_COST_TYPE_DTL_ID WHERE T74039.T_request_Id    = " + T_request_Id + " AND T74027.T_ITEM_UM_ID = T74089.T_ITEM_UM_ID AND T74089.T_ACTIVE = '1' GROUP BY T74040.T_PRSCRPTN_DTL_ID,  T74073.T_COST_TYPE_DTL_ID,   T74040.T_ITEM_CODE,  T74044.T_STORE_ID,  T74027.T_ITEM_UM_ID,  T74003.T_LANG2_NAME,  T74003.T_QTY,  T74040.T_GEN_CODE,  T74040.T_REQUEST_STRENGTH,  T74040.T_FORM_ID,  T74040.T_DRUG_ROUTE_CODE,  RUFAIDA.V30001.PRODUCT_DESC,  T74089.T_SALE_PRICE,T74040.T_DOSE_DURATION_CODE  UNION  SELECT T74040.T_PRSCRPTN_DTL_ID,  T74073.T_COST_TYPE_DTL_ID,  NVL(T74040.T_ITEM_CODE, 'N/A') T_ITEM_CODE,  T74044.T_STORE_ID,  T74027.T_ITEM_UM_ID,  T74003.T_LANG2_NAME PACK_SIZE,  fn_Stock_Qty(T74040.T_ITEM_CODE,T74027.T_ITEM_UM_ID,T74044.T_STORE_ID) STOCK,  T74003.T_QTY BOX_QTY,  (fn_Stock_Qty(T74040.T_ITEM_CODE,T74027.T_ITEM_UM_ID,T74044.T_STORE_ID)*T74003.T_QTY) PCS_QTY, fn_Pcs_Price(T74073.T_COST_TYPE_DTL_ID) PCS_PRICE,T74040.T_GEN_CODE,  T74040.T_REQUEST_STRENGTH,  T74040.T_FORM_ID,  T74040.T_DRUG_ROUTE_CODE,  RUFAIDA.V30001.PRODUCT_DESC,  T74089.T_SALE_PRICE,  T74040.T_DOSE_DURATION_CODE DOSE_QUANTITY FROM T74039 INNER JOIN T74040 ON T74039.T_PRESCRIPTION_ID = T74040.T_PRESCRIPTION_ID INNER JOIN T74041 ON T74041.T_REQUEST_ID = T74039.T_REQUEST_ID INNER JOIN T74044 ON T74044.T_AMBU_REG_ID = T74041.T_AMBU_REG_ID LEFT OUTER JOIN T74027 ON T74027.T_ITEM_ID = T74040.T_ITEM_CODE LEFT OUTER JOIN T74003 ON T74003.T_ITEM_UM_ID = T74027.T_ITEM_UM_ID LEFT OUTER JOIN RUFAIDA.V30001  ON V30001.ITEM_CODE = T74040.T_ITEM_CODE LEFT OUTER JOIN T74073 ON T74073.T_ID = T74040.T_ITEM_CODE LEFT OUTER JOIN T74089 ON T74089.T_COST_TYPE_DTL_ID = T74073.T_COST_TYPE_DTL_ID WHERE T74039.T_request_Id    = " + T_request_Id + " AND T74040.T_ITEM_CODE IS NULL GROUP BY T74040.T_PRSCRPTN_DTL_ID,T74073.T_COST_TYPE_DTL_ID, T74040.T_ITEM_CODE,T74044.T_STORE_ID,T74027.T_ITEM_UM_ID,T74003.T_LANG2_NAME, T74003.T_QTY, T74040.T_GEN_CODE, T74040.T_REQUEST_STRENGTH, T74040.T_DOSE_DURATION_CODE,T74040.T_FORM_ID,T74040.T_DRUG_ROUTE_CODE,RUFAIDA.V30001.PRODUCT_DESC, T74089.T_SALE_PRICE ORDER BY BOX_QTY ) ORDER BY T_ITEM_CODE,BOX_QTY");
        }

        public DataTable GetMedicineListByGen(int T_request_Id, string T_GEN_CODE, string T_REQUEST_STRENGTH, string T_DRUG_ROUTE_CODE, string T_FORM_ID)
        {
            //return Query("Select T74073.T_COST_TYPE_DTL_ID , V30001.ITEM_CODE ,T74044.T_STORE_ID, V30001.PRODUCT_DESC , T74089.T_SALE_PRICE,  GetDoseQuantity(T74040.T_PRSCRPTN_DTL_ID) DOSE_QUANTITY From T74040 Inner Join T74039 on T74039.T_PRESCRIPTION_ID = T74040.T_PRESCRIPTION_ID INNER JOIN T74041 ON T74041.T_REQUEST_ID = T74039.T_REQUEST_ID INNER JOIN T74044 ON T74044.T_AMBU_REG_ID = T74041.T_AMBU_REG_ID Inner join RUFAIDA.V30001 on V30001.GEN_CODE = T74040.T_GEN_CODE inner join T74073 on V30001.ITEM_CODE = T74073.T_ID LEFT OUTER JOIN T74089 ON T74089.T_COST_TYPE_DTL_ID = T74073.T_COST_TYPE_DTL_ID Where T74039.T_request_Id = " + T_request_Id + " AND T74040.T_ITEM_CODE is null AND GEN_CODE = '" + T_GEN_CODE+"' AND STRENGTH = '"+T_REQUEST_STRENGTH+"' AND ROUTE_CODE = '"+T_DRUG_ROUTE_CODE+"' AND FORM_CODE = '"+T_FORM_ID+"' ");


            //---------------------------------------working method---------------------------------------



            //return Query("SELECT T74044.T_STORE_ID,T74073.T_COST_TYPE_DTL_ID, T74027.T_ITEM_ID ITEM_CODE, T74073.T_LANG2_NAME PRODUCT_DESC, T74089.T_SALE_PRICE, GetDoseQuantity(T74040.T_PRSCRPTN_DTL_ID) DOSE_QUANTITY, T74027.T_ITEM_UM_ID,   T74003.T_LANG2_NAME PACK_SIZE,   fn_Stock_Qty(T74027.T_ITEM_ID,T74027.T_ITEM_UM_ID,T74044.T_STORE_ID) STOCK,   T74003.T_QTY BOX_QTY,   (fn_Stock_Qty(T74027.T_ITEM_ID,T74027.T_ITEM_UM_ID,T74044.T_STORE_ID)*T74003.T_QTY) PCS_QTY, fn_Pcs_Price(T74073.T_COST_TYPE_DTL_ID) PCS_PRICE FROM T74040 INNER JOIN T74039 ON T74039.T_PRESCRIPTION_ID = T74040.T_PRESCRIPTION_ID INNER JOIN T74041 ON T74041.T_REQUEST_ID = T74039.T_REQUEST_ID INNER JOIN T74044 ON T74044.T_AMBU_REG_ID = T74041.T_AMBU_REG_ID INNER JOIN RUFAIDA.V30001 ON V30001.GEN_CODE = T74040.T_GEN_CODE INNER JOIN T74073 ON V30001.ITEM_CODE = T74073.T_ID INNER JOIN T74027 ON T74027.T_ITEM_ID = T74073.T_ID INNER JOIN T74003 ON T74003.T_ITEM_UM_ID = T74027.T_ITEM_UM_ID INNER JOIN T74089 ON T74089.T_COST_TYPE_DTL_ID = T74073.T_COST_TYPE_DTL_ID WHERE T74039.T_request_Id    = " + T_request_Id + " AND T74040.T_ITEM_CODE      IS NULL AND GEN_CODE                 = '"+ T_GEN_CODE + "' AND STRENGTH                 = '"+ T_REQUEST_STRENGTH + "' AND ROUTE_CODE               = '"+ T_DRUG_ROUTE_CODE + "' AND FORM_CODE                = '"+ T_FORM_ID + "' AND T74089.T_ACTIVE = '1'AND T74027.T_ITEM_UM_ID = T74089.T_ITEM_UM_ID GROUP BY T74044.T_STORE_ID, T74073.T_COST_TYPE_DTL_ID, T74027.T_ITEM_ID ,  T74073.T_LANG2_NAME , T74089.T_SALE_PRICE, T74040.T_PRSCRPTN_DTL_ID ,  T74027.T_ITEM_UM_ID, T74003.T_LANG2_NAME ,T74003.T_QTY  ORDER BY ITEM_CODE, BOX_QTY");

            return Query("SELECT T74044.T_STORE_ID,T74073.T_COST_TYPE_DTL_ID, T74027.T_ITEM_ID ITEM_CODE, T74073.T_LANG2_NAME PRODUCT_DESC, T74089.T_SALE_PRICE,T74040.T_DOSE_DURATION_CODE DOSE_QUANTITY, T74027.T_ITEM_UM_ID,   T74003.T_LANG2_NAME PACK_SIZE,   fn_Stock_Qty(T74027.T_ITEM_ID,T74027.T_ITEM_UM_ID,T74044.T_STORE_ID) STOCK,   T74003.T_QTY BOX_QTY,   (fn_Stock_Qty(T74027.T_ITEM_ID,T74027.T_ITEM_UM_ID,T74044.T_STORE_ID)*T74003.T_QTY) PCS_QTY, fn_Pcs_Price(T74073.T_COST_TYPE_DTL_ID) PCS_PRICE FROM T74040 INNER JOIN T74039 ON T74039.T_PRESCRIPTION_ID = T74040.T_PRESCRIPTION_ID INNER JOIN T74041 ON T74041.T_REQUEST_ID = T74039.T_REQUEST_ID INNER JOIN T74044 ON T74044.T_AMBU_REG_ID = T74041.T_AMBU_REG_ID INNER JOIN RUFAIDA.V30001 ON V30001.GEN_CODE = T74040.T_GEN_CODE INNER JOIN T74073 ON V30001.ITEM_CODE = T74073.T_ID INNER JOIN T74027 ON T74027.T_ITEM_ID = T74073.T_ID INNER JOIN T74003 ON T74003.T_ITEM_UM_ID = T74027.T_ITEM_UM_ID INNER JOIN T74089 ON T74089.T_COST_TYPE_DTL_ID = T74073.T_COST_TYPE_DTL_ID WHERE T74039.T_request_Id    = " + T_request_Id + " AND T74040.T_ITEM_CODE      IS NULL AND GEN_CODE                 = '"+ T_GEN_CODE + "' AND STRENGTH                 = '"+ T_REQUEST_STRENGTH + "' AND ROUTE_CODE               = '"+ T_DRUG_ROUTE_CODE + "' AND FORM_CODE                = '"+ T_FORM_ID + "' AND T74089.T_ACTIVE = '1'AND T74027.T_ITEM_UM_ID = T74089.T_ITEM_UM_ID GROUP BY T74044.T_STORE_ID, T74073.T_COST_TYPE_DTL_ID, T74027.T_ITEM_ID ,  T74073.T_LANG2_NAME , T74089.T_SALE_PRICE, T74040.T_PRSCRPTN_DTL_ID ,  T74027.T_ITEM_UM_ID, T74040.T_DOSE_DURATION_CODE,T74003.T_LANG2_NAME ,T74003.T_QTY  ORDER BY ITEM_CODE, BOX_QTY");
            
        }

        public DataTable GetStock(int T_STORE_ID,int T_ITEM_ID)
        {
            return Query(
                "SELECT  T74027.T_ITEM_UM_ID, T74003.T_LANG2_NAME PACK_SIZE, fn_Stock_Qty(" + T_ITEM_ID + ",T74027.T_ITEM_UM_ID,"+T_STORE_ID +") STOCK, T74003.T_QTY BOX_QTY, (fn_Stock_Qty(" + T_ITEM_ID + ",T74027.T_ITEM_UM_ID," +T_STORE_ID +")*T74003.T_QTY) PCS_QTY FROM T74027 INNER JOIN T74003 ON T74003.T_ITEM_UM_ID = T74027.T_ITEM_UM_ID WHERE T_ITEM_ID = " + T_ITEM_ID + " AND T_STORE_ID = 11 GROUP BY T74027.T_ITEM_UM_ID,T74003.T_LANG2_NAME,T74003.T_QTY ORDER BY  BOX_QTY");
        }

        public DataTable GetConLevel()
        {
           return Query("SELECT T_LANG2_NAME T_LANG1_NAME ,T_CONS_LEVEL FROM T28135 WHERE T_ACTIVE_FLAG IS NOT NULL");
        }

        public string setHandoverHospital(int T_REQUEST_ID, string site)
        {
            string msg = "";
            BeginTransaction();
            if (Command($"UPDATE T74041 SET T_SITE_DIS_CODE='{site}',T_EVENT_FLAG=6,T_TEAM_SITE_CODE='{site}' WHERE T_REQUEST_ID={T_REQUEST_ID}"))
            {
                CommitTransaction();
                msg = "s";
            }
            else
            {
                RollbackTransaction();
                msg = "n";
            }
            return msg;
        }
        public string confirmDocHos(int T_REQUEST_ID, string T_SITE_CODE)
        {
            string msg = "";
            BeginTransaction();
            if (Command($"UPDATE T74041 SET T_SITE_DIS_CODE='{T_SITE_CODE}',T_DOC_REQ_ACPT_DATE=LOCALTIMESTAMP WHERE T_REQUEST_ID={T_REQUEST_ID}"))
            {
                CommitTransaction();
                msg = "s";
            }
            else
            {
                RollbackTransaction();
                msg = "n";
            }
            return msg;
        }
        public DataTable getDocHos(int T_REQUEST_ID)
        {
           // return Query($"SELECT T74041.T_REF_DOC_CODE,T02065.T_LANG2_NAME,T74041.T_DOC_REQ_ACPT_DATE FROM T74041 INNER JOIN T02065 ON T74041.T_REF_DOC_CODE=T02065.T_SITE_CODE WHERE T74041.T_REQUEST_ID={T_REQUEST_ID}");
            return Query($"select T11.T_REQUEST_ID, T11.T_HOS_REQ_USER_ID, T11.T_CANCEL_FLAG, T11.T_CANCEL_REASON_ID, T11.T_HOS_SITE_CODE, T11.T_REQUEST_ACPT_CNCL_TIME, T11.T_REQUEST_TIME, T65.T_LANG2_NAME, CASE WHEN T57.T_ROLE_CODE = '111' THEN 'ASOS' WHEN T57.T_ROLE_CODE = '24' THEN 'TEAM' WHEN T57.T_ROLE_CODE = '81' THEN 'DOCTOR' WHEN T57.T_ROLE_CODE = '86' THEN 'OPERATOR' END T_NAME, T57.T_ROLE_CODE, T04.T_FIRST_LANG2_NAME || ' '|| T04.T_FATHER_LANG2_NAME || ' '|| T04.T_FAMILY_LANG2_NAME SUGGEST_NAME from T74111 T11 INNER JOIN T02065 T65 ON T11.T_HOS_SITE_CODE = T65.T_SITE_CODE INNER JOIN T74057 T57 ON T11.T_HOS_REQ_USER_ID = T57.T_USER_ID INNER JOIN T74004 T04 ON T57.T_EMP_ID = T04.T_EMP_ID where T_CANCEL_FLAG is null and T_REQUEST_ACPT_CNCL_TIME is null and T_REQUEST_ID = {T_REQUEST_ID} ");
        }
        public DataTable getOprHos(int T_REQUEST_ID)
        {
            return Query(
                $"SELECT T74041.T_OPER_DES_CODE,T02065.T_LANG2_NAME,T74041.T_OPER_ACPT_DATE FROM T74041 INNER JOIN T02065 ON T74041.T_OPER_DES_CODE=T02065.T_SITE_CODE WHERE T74041.T_REQUEST_ID={T_REQUEST_ID}");
        }
        public DataTable getTeamLatLng(string user)
        {
            return Query($"SELECT *  FROM (SELECT * FROM T74026 WHERE T_USER_ID='{user}' AND T_LATITUDE IS NOT NULL ORDER BY T_ENTRY_TIME DESC) WHERE ROWNUM=1 ");
        }
        public string setDoc(string zone, int req, string user)
        {
            string msg = "";
            //DataTable dt= Query($"SELECT T57.T_USER_ID FROM T74057 T57 WHERE T57.T_ZONE_CODE='{zone}' AND T57.T_ROLE_CODE=81 AND T57.T_USER_ID NOT IN (SELECT DISTINCT T74041.T_CHAT_DOC_ID FROM T74041 WHERE T74041.T_DISCH_STATUS IS NULL  AND T_CHAT_DOC_ID IS NOT NULL AND T74041.T_USER_ID IS NOT NULL AND T74041.T_CANCEL_STATUS IS NULL )");


            //DataTable dt = Query($"SELECT '1' sl, T57.T_USER_ID FROM T74057 T57 WHERE T57.T_ZONE_CODE ='{zone}' AND T57.T_ROLE_CODE =81 AND T57.T_USER_ID NOT IN (SELECT DISTINCT T74041.T_CHAT_DOC_ID FROM T74041 WHERE T74041.T_DISCH_STATUS IS NULL AND T_CHAT_DOC_ID IS NOT NULL AND T74041.T_USER_ID IS NOT NULL AND T74041.T_CANCEL_STATUS IS NULL ) UNION SELECT DISTINCT '2' SL,T41.T_CHAT_DOC_ID T_USER_ID FROM T74041 T41 INNER JOIN T74057 T57 ON T57.T_USER_ID=T41.T_CHAT_DOC_ID LEFT JOIN T74105 T05 ON T41.T_REQUEST_ID=T05.T_REQUEST_ID WHERE T41.T_DISCH_STATUS IS NULL AND T41.T_CHAT_DOC_ID IS NOT NULL AND T41.T_USER_ID IS NOT NULL AND T41.T_CANCEL_STATUS IS NULL AND T57.T_ROLE_CODE=81 AND T57.T_ZONE_CODE={zone} AND T05.T_REQUEST_ID IS NULL UNION SELECT DISTINCT DECODE(T05.T_FINAL_FLAG,NULL,'4','3') SL,T41.T_CHAT_DOC_ID T_USER_ID FROM T74041 T41 INNER JOIN T74057 T57 ON T57.T_USER_ID=T41.T_CHAT_DOC_ID LEFT JOIN T74105 T05 ON T41.T_REQUEST_ID=T05.T_REQUEST_ID WHERE T41.T_DISCH_STATUS IS NULL AND T41.T_CHAT_DOC_ID IS NOT NULL AND T41.T_USER_ID IS NOT NULL AND T41.T_CANCEL_STATUS IS NULL AND T57.T_ROLE_CODE=81 AND T57.T_ZONE_CODE={zone} AND T05.T_REQUEST_ID IS NOT NULL ORDER BY sl");
            //-------------------------------------This is ok. Changed for new requirement-----------------------
            //DataTable dt = Query($"SELECT 0 sl, T57.T_USER_ID FROM T74057 T57 WHERE T57.T_ZONE_CODE ={zone} AND T57.T_ROLE_CODE =81 AND T57.T_USER_ID NOT IN (SELECT DISTINCT T74041.T_CHAT_DOC_ID FROM T74041 WHERE T74041.T_DISCH_STATUS IS NULL AND T_CHAT_DOC_ID IS NOT NULL AND T74041.T_USER_ID IS NOT NULL AND T74041.T_CANCEL_STATUS IS NULL ) UNION SELECT DISTINCT count(T41.T_CHAT_DOC_ID )sl,T41.T_CHAT_DOC_ID FROM T74041 T41 INNER JOIN T74057 T57 ON T57.T_USER_ID=T41.T_CHAT_DOC_ID WHERE T41.T_DISCH_STATUS IS NULL AND T41.T_CHAT_DOC_ID IS NOT NULL AND T41.T_USER_ID IS NOT NULL AND T41.T_CANCEL_STATUS IS NULL AND T57.T_ROLE_CODE =81 AND T57.T_ZONE_CODE ={zone} group by T41.T_CHAT_DOC_ID order by sl");

            //--------------------------Previous query Changed for new requirement-----------------------
            DataTable dt = Query($"SELECT 0 sl, T57.T_USER_ID FROM T74057 T57 WHERE T57.T_ZONE_CODE ={zone} AND T57.T_ROLE_CODE =81 AND T57.T_USER_ID NOT IN (SELECT DISTINCT T74041.T_CHAT_DOC_ID FROM T74041 WHERE T74041.T_DISCH_STATUS IS NULL AND T_CHAT_DOC_ID IS NOT NULL AND T74041.T_USER_ID IS NOT NULL AND T74041.T_CANCEL_STATUS IS NULL ) AND T57.T_LOGIN_STATUS = 1 UNION SELECT DISTINCT count(T41.T_CHAT_DOC_ID )sl,T41.T_CHAT_DOC_ID FROM T74041 T41 INNER JOIN T74057 T57 ON T57.T_USER_ID=T41.T_CHAT_DOC_ID WHERE T41.T_DISCH_STATUS IS NULL AND T41.T_CHAT_DOC_ID IS NOT NULL AND T41.T_USER_ID IS NOT NULL AND T41.T_CANCEL_STATUS IS NULL AND T57.T_ROLE_CODE =81 AND T57.T_ZONE_CODE ={zone} AND T57.T_LOGIN_STATUS = 1 group by T41.T_CHAT_DOC_ID order by sl");


            if (dt.Rows.Count > 0)
            {
                BeginTransaction();
                if (Command($"UPDATE T74041 SET T_CHAT_FLAG='1',T_CHAT_DOC_ID='{dt.Rows[0]["T_USER_ID"].ToString()}' WHERE T_REQUEST_ID='{req}'") && Command($"INSERT INTO T74105 (T_REQUEST_ID,T_CHAT_REQ_ID,T_CHAT_REQ_TIME) VALUES ({req},'{user}',LOCALTIMESTAMP)"))
                {
                    CommitTransaction();
                    msg = dt.Rows[0]["T_USER_ID"].ToString();
                }
                else
                {
                    RollbackTransaction();
                }
            }
            return msg;

        }

        public DataTable getStationArrivalTime(int requId)
        {
            return Query($"SELECT T.*, ( SELECT T.HOURS*60+T.MI FROM dual )TOTAL_MINUTE FROM ( select abs(24*extract(day from diff)+extract(HOUR from diff)) HOURS, abs(extract(day from diff)+extract(MINUTE from diff)) MI from ( select to_timestamp_tz( T_TEAM_ARVL_STN, 'dd-mon-yyyy hh:mi:ssxff PM tzh:tzm') - to_timestamp_tz( systimestamp, 'dd-mon-yyyy hh:mi:ssxff PM tzh:tzm') diff from T74041 where T_REQUEST_ID={requId} AND T_RDY_FOR_NXT_PAT is null ) )T ");
        }

        public string UpdateT74111(int t_REQUEST_ID, string t_SITE_CODE, string t_NAME)
        {
            string msg = "";
            BeginTransaction();
            if (Command($"UPDATE T74111 SET T_REQUEST_ACPT_CNCL_TIME=LOCALTIMESTAMP WHERE T_REQUEST_ID={t_REQUEST_ID} AND T_HOS_SITE_CODE = '{t_SITE_CODE}' "))
            {
                CommitTransaction();
                msg = "s";
            }
            else
            {
                RollbackTransaction();
                msg = "n";
            }
            return msg;
        }

        public string Cancel_Suggested_Hospital(int tRequestId, string tSiteCode)
        {
            string msg = "";
            BeginTransaction();
            if (Command($"UPDATE T74111 SET T_REQUEST_ACPT_CNCL_TIME=LOCALTIMESTAMP,T_CANCEL_FLAG='1'  WHERE T_REQUEST_ID={tRequestId} AND T_HOS_SITE_CODE = '{tSiteCode}' "))
            {
                CommitTransaction();
                msg = "s";
            }
            else
            {
                RollbackTransaction();
                msg = "n";
            }
            return msg;
        }


        public string insert117(T74041 canT41)
        {
            var sms = "";
            bool d = false;
             var T_ID = Query($"SELECT NVL(MAX(T_ID),0)+1 T_ID FROM T74117").Rows[0]["T_ID"].ToString();
            var T_USER_ID = Query($" SELECT T_USER_ID FROM T74041 WHERE T_REQUEST_ID = {canT41.T_REQUEST_ID}").Rows[0]["T_USER_ID"].ToString();
            if (T_ID != null)
            {
                BeginTransaction();
               
                    d = Command($"INSERT INTO T74117 (T_ID, T_REQUEST_ID, T_REQ_USER_ID, T_REQ_DATE,T_TYPE) VALUES ({T_ID},{canT41.T_REQUEST_ID},'{T_USER_ID}',LOCALTIMESTAMP,'{canT41.T_CANCEL_REASON}' )");

                if (d)
                {
                    CommitTransaction();
                    sms = "1";
                }
                else
                {
                    RollbackTransaction();
                    sms = "2";
                }
            }
       

            return sms;



        }

        public string InsertCleanAmbulance(T74117 t74117,string user,string lang)
        {
            string msg = "";
            bool saveOrUpdate = false;

            var T_CLN_ID = Query($"SELECT nvl(max(T_ID),0)+1 T_ID FROM T74117").Rows[0]["T_ID"].ToString();
            var isFlag = Query($"SELECT T_FINAL_FLAG FROM T74117 WHERE T_REQ_USER_ID = '{user}' order by T_ID desc");
            //var isFlag = Query($"SELECT T_FINAL_FLAG FROM T74117 WHERE T_REQ_USER_ID = '{user}' order by T_ID desc").Rows[0]["T_FINAL_FLAG"].ToString();

            var flagData = "";

            if (isFlag.Rows.Count > 0)
            {
                flagData = string.IsNullOrEmpty(isFlag.Rows[0]["T_FINAL_FLAG"].ToString()) ? null : isFlag.Rows[0]["T_FINAL_FLAG"].ToString();


            }

            if (T_CLN_ID != null && flagData!=null)
            {
                BeginTransaction();

                saveOrUpdate =
                            Command(
                                $"INSERT INTO T74117 (T_ID,T_REQ_USER_ID,T_REQ_DATE,T_TYPE) VALUES ({T_CLN_ID},'{user}',LOCALTIMESTAMP,'11')");


                if (saveOrUpdate)
                {
                    CommitTransaction();
                    //msg = "Ambulance Cleaned successfully";
                    msg = GetSingleMsg(lang, "S0125");
                }
                else
                {
                    RollbackTransaction();
                    //msg = "Ambulance Cannot Cleaned";
                    msg = GetSingleMsg(lang, "S0126");
                }
            }
            else
            {
                //msg = "Request Already pending";
                msg = GetSingleMsg(lang, "S0127");
            }

            //else
            //{
            //    //msg = "Request Not Found";
            //    msg = GetSingleMsg(lang, "S0131");
            //}



            return msg;

        }

        public string InsertConfirmCleanAmbulance(T74117 t74117, string user,string lang)
        {
            string msg = "";
            bool saveOrUpdate = false;

            var isConfirmToClean = Query($"SELECT T_REQ_USER_ID,T_STATUS,T_FINAL_FLAG FROM T74117 WHERE T_REQ_USER_ID = '{user}' AND T_STATUS='1' AND T_FINAL_FLAG IS NULL");

            if (isConfirmToClean.Rows.Count>0)
            {
                BeginTransaction();

                saveOrUpdate =Command($"UPDATE T74117  SET T_DONE_USER_ID='{user}',T_DONE_USER_DATE=LOCALTIMESTAMP,T_FINAL_FLAG=1 WHERE T_REQ_USER_ID = '{user}' AND T_STATUS='1' AND T_FINAL_FLAG IS NULL");
                if (t74117.T_REQUEST_ID !=0)
                {
                    Command($"UPDATE T74041  SET T_RDY_FOR_NXT_PAT=LOCALTIMESTAMP,T_EVENT_FLAG=11,T_DISCH_STATUS='1' WHERE T_REQUEST_ID={t74117.T_REQUEST_ID}");

                    //Command(
                    //    $"INSERT INTO T74026 (T_USER_ID, T_ENTRY_TIME, T_REQUEST_ID, T_EVENT_ID) VALUES ('{user}',LOCALTIMESTAMP,{t74117.T_REQUEST_ID},11)");
                }



                if (saveOrUpdate)
                {
                    CommitTransaction();
                    //msg = "Ambulance Cleaned Confirmed successfully";
                    msg = GetSingleMsg(lang, "S0129");
                }
                else
                {
                    RollbackTransaction();
                    //msg = "Somethings went wrong";
                    msg = GetSingleMsg(lang, "S0128");
                }
            }
            else
            {
                //msg = "Request Not Accepted";
                msg = GetSingleMsg(lang, "S0130");
            }

            return msg;

        }

        public DataTable NationalityData(string lang)
        {
            return Query($"SELECT T_NTNLTY_ID ,T_LANG{lang}_NAME  FROM T74205");
        }

        public string getMewsScoreData(T74043 t74043)
        {
          var k=  Query($"select nvl((SELECT T_SCORE from t28067 where T_H_SCOR = upper(ltrim(rtrim('{t74043.T_CONCIUS_LEVEL}'))) and T_MEU_CODE='04'),0)+ nvl((SELECT T_SCORE from t28067 where {t74043.T_TEMP} between T_L_SCOR and T_H_SCOR and T_MEU_CODE='08'),0)+ nvl((SELECT T_SCORE from t28067 where {t74043.T_PULS} between T_L_SCOR and T_H_SCOR and T_MEU_CODE='05'),0)+ nvl((SELECT T_SCORE from t28067 where {t74043.T_BP_SYS} between T_L_SCOR and T_H_SCOR and T_MEU_CODE='01'),0)+ nvl((SELECT T_SCORE from t28067 where {t74043.T_RESP} between T_L_SCOR and T_H_SCOR and T_MEU_CODE='02'),0)+ nvl((SELECT T_SCORE from t28067 where {t74043.T_OS} between T_L_SCOR and T_H_SCOR and T_MEU_CODE='03'),0)+ nvl((SELECT T_SCORE from t28067 where {t74043.T_URINE_TEST} between T_L_SCOR and T_H_SCOR and T_MEU_CODE='06'),0) score from dual").Rows[0]["score"].ToString();
            return k;
        }

        public DataTable getMewsData(string user, int reId)
        {
            return Query($"SELECT T_3.T_PCHECKUP_ID_1,T_3.T_SCORE_1,T_3.T_PCHECKUP_ID_2,T_3.T_SCORE_2, CASE WHEN T_3.T_SCORE_1>=0 AND T_SCORE_1<18 THEN T_3.T_SCORE_1 ELSE 100 END T_SCORE FROM ( SELECT T_2.*, (SELECT T_1.T_PCHECKUP_ID PCID FROM ( SELECT ROWNUM RONUM, T_PCHECKUP_ID,T_SCORE FROM T74043 Where T_REQUEST_ID = {reId} ORDER BY T_PCHECKUP_ID DESC )T_1 WHERE T_1.RONUM IN (2))T_PCHECKUP_ID_2, (SELECT T_1.T_SCORE SCR FROM ( SELECT ROWNUM RONUM, T_PCHECKUP_ID,T_SCORE FROM T74043 Where T_REQUEST_ID = {reId} ORDER BY T_PCHECKUP_ID DESC )T_1 WHERE T_1.RONUM IN (2))T_SCORE_2 FROM (SELECT T_1.RONUM RONUM_1, T_1.T_PCHECKUP_ID T_PCHECKUP_ID_1,T_1.T_SCORE T_SCORE_1 FROM (SELECT ROWNUM RONUM, T_PCHECKUP_ID,T_SCORE FROM T74043 Where T_REQUEST_ID = {reId} ORDER BY T_PCHECKUP_ID DESC )T_1 WHERE T_1.RONUM IN (1) )T_2 )T_3");
        }
    }
}