using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Web;

namespace AmbucareDAL.Repository.DAL.Query
{
    public class Q74146DAL : CommonDAL
    {
        public DataTable GetAmbulanceList(string zone, string role)
        {
            return Query($"select t74057.t_user_id,t74015.T_AMBU_REG_ID from t74057 join t74015 on t74057.T_EMP_ID = t74015.T_EMP_ID join t74044 on t74015.T_AMBU_REG_ID = t74044.T_AMBU_REG_ID where t_role_code = '24' and t_zone_code ='{zone}' order by t74015.T_AMBU_REG_ID asc");
        }

        public DataTable GetStockItem(int ambuId, int reqId)
        {
            return Query($"SELECT DISTINCT T74044.T_STORE_ID, T74041.T_AMBU_REG_ID,T74041.T_USER_ID, T74073.T_LANG2_NAME, fn_Stock_Qty_Instant(t74027.T_ITEM_ID,t74044.T_STORE_ID) STOCK ,fn_Issue_Qty(t74027.T_ITEM_ID,t74044.T_STORE_ID)ISSUE_QUTY, t74027.T_ITEM_ID , (SELECT DISTINCT T74037.T_ITEM_ID FROM t74037 JOIN T74036 ON T74037.T_ISSUE_ID = T74036.T_ISSUE_ID WHERE t74036.t_request_id=t74041.t_request_id AND T74037.T_ITEM_ID =t74027.T_ITEM_ID ) ISSED_ITEM, (SELECT SUM(ROUND(T74037.T_QUANTITY*T74003.T_QTY)) ADMINISTED_QTY FROM t74037 JOIN T74036 ON T74037.T_ISSUE_ID = T74036.T_ISSUE_ID JOIN T74003 ON T74037.T_UOM_ID = T74003.T_ITEM_UM_ID WHERE t74036.t_request_id=t74041.t_request_id AND T74037.T_ITEM_ID =t74027.T_ITEM_ID ) ADMINISTERED_QUTY,fn_Admin_Qty(t74027.T_ITEM_ID,'{reqId}') T_DOSE_DURATION_CODE FROM T74041 JOIN T74044 ON T74041.T_AMBU_REG_ID = T74044.T_AMBU_REG_ID JOIN t74027 ON T74044.T_STORE_ID = t74027.T_STORE_ID JOIN T74073 ON t74027.T_ITEM_ID = T74073.T_ID LEFT JOIN T74039 ON T74041.T_REQUEST_ID = T74039.T_REQUEST_ID LEFT JOIN T74040 ON T74039.T_PRESCRIPTION_ID = T74040.T_PRESCRIPTION_ID WHERE T74041.T_AMBU_REG_ID ={ambuId} AND T_COST_TYPE_ID ='23' and t74041.t_request_id='{reqId}'  GROUP BY T74044.T_STORE_ID, T74041.T_AMBU_REG_ID,T74041.T_USER_ID, t74027.T_ITEM_ID, T74073.T_LANG2_NAME , T_DOSE_DURATION_CODE, T74040.T_PRESCRIPTION_ID , t74041.t_request_id ORDER BY T74073.T_LANG2_NAME ASC");
            // return Query("");
        }

        public string getReqId(int ambuId)
        {
            return Query($"SELECT * FROM (SELECT T_REQUEST_ID FROM T74041 WHERE T_AMBU_REG_ID = '{ambuId}' ORDER BY T_REQUEST_ID DESC) WHERE ROWNUM = 1 ").Rows[0]["T_REQUEST_ID"].ToString();

        }

        public DataTable GetAcceptedData(string zoneCode, string userid, string fromDate, string toDate)
        {
            if (userid == "ALL")
            {
                return Query($"SELECT t41.T_REQUEST_ID, t41. T_USER_ID, t46.T_PAT_ID, t46.T_FIRST_LANG2_NAME ||' ' || t46.T_FATHER_LANG2_NAME ||' ' || t46.T_GFATHER_LANG2_NAME ||' ' || t46.T_FAMILY_LANG2_NAME PAT_NAME, t41.T_ACCEPT_STATUS, TO_CHAR(t41.T_ACCEPT_TIME,'DD-MON-YYYY')ACCEPT_DATE, TO_CHAR(t41.T_ACCEPT_TIME,'HH24:MI:SS')ACCEPT_TIME FROM T74041 t41 JOIN T74046 t46 ON t41.T_PAT_ID= t46.T_PAT_ID JOIN T74057 t57 ON t41.T_USER_ID= t57.T_USER_ID WHERE t57.T_ZONE_CODE = '{zoneCode}' AND T_ACCEPT_STATUS ='1' AND T_ACCEPT_TIME BETWEEN TO_DATE('{fromDate}', 'DD-MON-YY') AND TO_DATE('{toDate}', 'DD-MON-YY')+ (1-1/24/60/60)");
            }
            else
            {
                return Query($"SELECT t41.T_REQUEST_ID, t41. T_USER_ID, t46.T_PAT_ID, t46.T_FIRST_LANG2_NAME ||' ' || t46.T_FATHER_LANG2_NAME ||' ' || t46.T_GFATHER_LANG2_NAME ||' ' || t46.T_FAMILY_LANG2_NAME PAT_NAME, t41.T_ACCEPT_STATUS, TO_CHAR(t41.T_ACCEPT_TIME,'DD-MON-YYYY')ACCEPT_DATE, TO_CHAR(t41.T_ACCEPT_TIME,'HH24:MI:SS')ACCEPT_TIME FROM T74041 t41 JOIN T74046 t46 ON t41.T_PAT_ID= t46.T_PAT_ID JOIN T74057 t57 ON t41.T_USER_ID= t57.T_USER_ID WHERE t57.T_ZONE_CODE = '{zoneCode}' AND T_ACCEPT_STATUS ='1' AND t41.t_user_id ='{userid}' AND T_ACCEPT_TIME BETWEEN TO_DATE('{fromDate}', 'DD-MON-YY') AND TO_DATE('{toDate}', 'DD-MON-YY')+ (1-1/24/60/60)");
            }

        }
        public DataTable GetRejectedData(string zoneCode, string userid, string fromDate, string toDate)
        {
            if (userid == "ALL")
            {
                return Query($"SELECT t41.T_REQUEST_ID, t41. T_USER_ID, t46.T_PAT_ID, t46.T_FIRST_LANG2_NAME ||' ' || t46.T_FATHER_LANG2_NAME ||' ' || t46.T_GFATHER_LANG2_NAME ||' ' || t46.T_FAMILY_LANG2_NAME PAT_NAME, t41.T_ACCEPT_STATUS, t41.T_CANCEL_REASON, t01.T_LANG2_NAME CANCEL_DETAILS, TO_CHAR(t41.T_CAN_DATE,'DD-MON-YYYY')T_CAN_DATE, TO_CHAR(t41.T_CAN_DATE,'HH24:MI:SS')T_CAN_TIME FROM T74041 t41 JOIN T74046 t46 ON t41.T_PAT_ID= t46.T_PAT_ID JOIN T74057 t57 ON t41.T_USER_ID= t57.T_USER_ID JOIN T74101 t01 ON t41.T_CANCEL_REASON = TO_CHAR(t01.T_CANCEL_REASON_ID) WHERE t57.T_ZONE_CODE = '{zoneCode}' AND T_CAN_DATE BETWEEN TO_DATE('{fromDate}', 'DD-MON-YY') AND TO_DATE('{toDate}', 'DD-MON-YY')");
            }
            else
            {
                return Query($"SELECT t41.T_REQUEST_ID, t41. T_USER_ID, t46.T_PAT_ID, t46.T_FIRST_LANG2_NAME ||' ' || t46.T_FATHER_LANG2_NAME ||' ' || t46.T_GFATHER_LANG2_NAME ||' ' || t46.T_FAMILY_LANG2_NAME PAT_NAME, t41.T_ACCEPT_STATUS, t41.T_CANCEL_REASON, t01.T_LANG2_NAME CANCEL_DETAILS, TO_CHAR(t41.T_CAN_DATE,'DD-MON-YYYY')T_CAN_DATE, TO_CHAR(t41.T_CAN_DATE,'HH24:MI:SS')T_CAN_TIME FROM T74041 t41 JOIN T74046 t46 ON t41.T_PAT_ID= t46.T_PAT_ID JOIN T74057 t57 ON t41.T_USER_ID= t57.T_USER_ID JOIN T74101 t01 ON t41.T_CANCEL_REASON = TO_CHAR(t01.T_CANCEL_REASON_ID) WHERE t57.T_ZONE_CODE = '{zoneCode}' AND t57.T_USER_ID = '{userid}' AND T_CAN_DATE BETWEEN TO_DATE('{fromDate}', 'DD-MON-YY') AND TO_DATE('{toDate}', 'DD-MON-YY')");
            }

        }
        public DataTable GetAllRequest(string zoneCode, string userid, string fromDate, string toDate)
        {
            if (userid == "ALL")
            {
                return Query($"SELECT t41.T_REQUEST_ID, t41. T_USER_ID, t46.T_PAT_ID, t46.T_FIRST_LANG2_NAME ||' ' || t46.T_FATHER_LANG2_NAME ||' ' || t46.T_GFATHER_LANG2_NAME ||' ' || t46.T_FAMILY_LANG2_NAME PAT_NAME,t41.T_AGE,t50.T_LANG2_NAME SEX, t41.T_ACCEPT_STATUS,t41.T_CAN_DATE, TO_CHAR(t41.T_REQUEST_DATE,'DD-MON-YYYY')T_REQUEST_DATE, TO_CHAR(t41.T_REQUEST_TIME,'HH24:MI:SS')T_REQUEST_TIME FROM T74041 t41 JOIN T74046 t46 ON t41.T_PAT_ID= t46.T_PAT_ID JOIN T74050 T50 ON T50.T_SEX_CODE = T46.T_SEX_CODE JOIN T74057 t57 ON t41.T_USER_ID = t57.T_USER_ID WHERE t57.T_ZONE_CODE = '{zoneCode}' AND T_REQUEST_DATE BETWEEN TO_DATE('{fromDate}', 'DD-MON-YY') AND TO_DATE('{toDate}', 'DD-MON-YY')+ (1-1/24/60/60)");
            }
            else
            {
                return Query($"SELECT t41.T_REQUEST_ID, t41. T_USER_ID, t46.T_PAT_ID, t46.T_FIRST_LANG2_NAME ||' ' || t46.T_FATHER_LANG2_NAME ||' ' || t46.T_GFATHER_LANG2_NAME ||' ' || t46.T_FAMILY_LANG2_NAME PAT_NAME,t41.T_AGE,t50.T_LANG2_NAME SEX, t41.T_ACCEPT_STATUS,t41.T_CAN_DATE, TO_CHAR(t41.T_REQUEST_DATE,'DD-MON-YYYY')T_REQUEST_DATE, TO_CHAR(t41.T_REQUEST_TIME,'HH24:MI:SS')T_REQUEST_TIME FROM T74041 t41 JOIN T74046 t46 ON t41.T_PAT_ID= t46.T_PAT_ID JOIN T74050 T50 ON T50.T_SEX_CODE = T46.T_SEX_CODE JOIN T74057 t57 ON t41.T_USER_ID = t57.T_USER_ID WHERE t57.T_ZONE_CODE = '{zoneCode}' AND t41.T_USER_ID ='{userid}' AND T_REQUEST_DATE BETWEEN TO_DATE('{fromDate}', 'DD-MON-YY') AND TO_DATE('{toDate}', 'DD-MON-YY')+ (1-1/24/60/60)");
            }

        }


        public DataTable GetUsedMedicineByTeam(string userid)
        {
            return Query($"SELECT t_index, 'DOSE' ||T_INDEX T_DOSE, ITEM_CODE, GEN_DESC, T_LANG2_NAME ITEM_DESC, T_ISSUE_ID, T_ENTRY_TIME, T_USER_ID, T_REQUEST_ID, ROUND(T_QUANTITY*tt) T_QTY FROM (SELECT DENSE_RANK() OVER(Order By t74036.T_ISSUE_ID) AS t_index, V30001.ITEM_CODE, V30001.GEN_DESC, T74073.T_LANG2_NAME, t74036.T_ISSUE_ID, t74036.T_ENTRY_TIME, T74041.T_USER_ID, t74036.T_REQUEST_ID, SUM(t74037.T_QUANTITY) T_QUANTITY, (SELECT T_QTY FROM T74003 WHERE T_ITEM_UM_ID = t74037.T_UOM_ID ) tt FROM t74036 INNER JOIN t74037 ON t74036.T_ISSUE_ID = t74037.T_ISSUE_ID INNER JOIN T74074 ON t74036.T_ISSUE_ID = T74074.T_ISSUE_ID INNER JOIN V30001 ON t74037.T_ITEM_ID = V30001.ITEM_CODE LEFT JOIN T74073 ON t74037.T_ITEM_ID = T74073.T_ID JOIN T74041 ON t74036.T_REQUEST_ID=T74041.T_REQUEST_ID WHERE T74041.T_USER_ID='{userid}' GROUP BY V30001.ITEM_CODE, V30001.GEN_DESC, T74073.T_LANG2_NAME, t74036.T_ENTRY_TIME, t74037.T_UOM_ID, t74036.T_ISSUE_ID, T74041.T_USER_ID, t74036.T_REQUEST_ID ORDER BY t74036.T_REQUEST_ID DESC )");
        }

        public DataTable GetUsedMedicineByRequest(int requestId)
        {
            return Query($"SELECT DISTINCT T74044.T_STORE_ID, T74041.T_AMBU_REG_ID, T74041.T_USER_ID, T74073.T_LANG2_NAME, fn_Stock_Qty_Instant(t74027.T_ITEM_ID,t74044.T_STORE_ID) STOCK , t74027.T_ITEM_ID , (SELECT DISTINCT T74037.T_ITEM_ID FROM t74037 JOIN T74036 ON T74037.T_ISSUE_ID = T74036.T_ISSUE_ID WHERE t74036.t_request_id=t74041.t_request_id AND T74037.T_ITEM_ID =t74027.T_ITEM_ID ) ISSED_ITEM, (SELECT SUM(ROUND(T74037.T_QUANTITY*T74003.T_QTY)) ADMINISTED_QTY FROM t74037 JOIN T74036 ON T74037.T_ISSUE_ID = T74036.T_ISSUE_ID JOIN T74003 ON T74037.T_UOM_ID = T74003.T_ITEM_UM_ID WHERE t74036.t_request_id=t74041.t_request_id AND T74037.T_ITEM_ID =t74027.T_ITEM_ID ) ADMINISTERED_QUTY, fn_Admin_Qty(t74027.T_ITEM_ID,'2112') T_DOSE_DURATION_CODE FROM T74041 JOIN T74044 ON T74041.T_AMBU_REG_ID = T74044.T_AMBU_REG_ID JOIN t74027 ON T74044.T_STORE_ID = t74027.T_STORE_ID JOIN T74073 ON t74027.T_ITEM_ID = T74073.T_ID LEFT JOIN T74039 ON T74041.T_REQUEST_ID = T74039.T_REQUEST_ID LEFT JOIN T74040 ON T74039.T_PRESCRIPTION_ID = T74040.T_PRESCRIPTION_ID WHERE T74041.T_AMBU_REG_ID =231 AND T_COST_TYPE_ID ='23' AND t74041.t_request_id ='2112' GROUP BY T74044.T_STORE_ID, T74041.T_AMBU_REG_ID, t74027.T_ITEM_ID, T74073.T_LANG2_NAME , T_DOSE_DURATION_CODE, T74040.T_PRESCRIPTION_ID , t74041.t_request_id, T74041.T_USER_ID ORDER BY T74073.T_LANG2_NAME ASC");
        }

        public DataTable GetStorId(int ambuId)
        {
            return Query($"SELECT T_STORE_ID FROM T74044 WHERE T_AMBU_REG_ID ='{ambuId}'");
        }
    }
}